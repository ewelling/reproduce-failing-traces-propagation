# Reproducer for failing propagation of opentelemetry traces 

This reproducer is based on the [opentelemetry-quickstart](https://github.com/quarkusio/quarkus-quickstarts/tree/main/opentelemetry-quickstart) project.

## Building and running the reproducer
First, start Kafka, OpenTelemetry Collector and Jaeger UI using `otel-collector-config.yaml`:
```shell script
sudo docker-compose up
```

Build the application:
```shell script
./mvnw clean install -DskipTests=true
```

Run it:
```shell script
./mvnw quarkus:dev
```

## Reproducing
Run `TracedResourceTest.testHelloEndpoint()` in your IDE.

As you can see from the System's output, the context when sending contains a trace id (which is contained in the event's `TracingMetadata` header):

    Context when sending: {opentelemetry-http-server-route-key=io.opentelemetry.instrumentation.api.instrumenter.http.HttpRouteHolder@68cf598e, opentelemetry-trace-span-key=SdkSpan{traceId=136040742b4c007790397c29a64a14e4, spanId=61e5ce8cf88c15c0, parentSpanContext=ImmutableSpanContext{traceId=136040742b4c007790397c29a64a14e4, spanId=0555be30bbd62fbc, traceFlags=01, traceState=ArrayBasedTraceState{entries=[]}, remote=false, valid=true}, name=send, kind=INTERNAL, attributes=null, status=ImmutableStatusData{statusCode=UNSET, description=}, totalRecordedEvents=0, totalRecordedLinks=0, startEpochNanos=1662629497035220043, endEpochNanos=0}, opentelemetry-traces-span-key-server=SdkSpan{traceId=136040742b4c007790397c29a64a14e4, spanId=0555be30bbd62fbc, parentSpanContext=ImmutableSpanContext{traceId=00000000000000000000000000000000, spanId=0000000000000000, traceFlags=00, traceState=ArrayBasedTraceState{entries=[]}, remote=false, valid=false}, name=/hello, kind=SERVER, attributes=AttributesMap{data={http.target=/hello, http.route=/hello, http.user_agent=Apache-HttpClient/4.5.13 (Java/11.0.15), http.flavor=1.1, http.method=GET, http.client_ip=127.0.0.1, http.scheme=http, http.host=localhost:8081}, capacity=128, totalAddedValues=8}, status=ImmutableStatusData{statusCode=UNSET, description=}, totalRecordedEvents=0, totalRecordedLinks=0, startEpochNanos=1662629497013422000, endEpochNanos=0}}

That same trace id appears in the logs when receiving the message:

    Received context: {opentelemetry-trace-span-key=SdkSpan{traceId=136040742b4c007790397c29a64a14e4, spanId=dea281a5efd845bb, parentSpanContext=ImmutableSpanContext{traceId=136040742b4c007790397c29a64a14e4, spanId=e8d0f6408e41967c, traceFlags=01, traceState=ArrayBasedTraceState{entries=[]}, remote=true, valid=true}, name=myevents receive, kind=CONSUMER, attributes=AttributesMap{data={offset=7, messaging.destination=myevents, messaging.kafka.partition=0, messaging.kafka.client_id=kafka-consumer-myevents-in, messaging.consumer_id=myservice - kafka-consumer-myevents-in, messaging.kafka.consumer_group=myservice, messaging.destination_kind=topic, messaging.system=kafka}, capacity=128, totalAddedValues=8}, status=ImmutableStatusData{statusCode=UNSET, description=}, totalRecordedEvents=0, totalRecordedLinks=0, startEpochNanos=1662629498101585000, endEpochNanos=1662629498101647687}}

In Jaeger UI (http://localhost:16686/), the spans generated by `myservice` appear nested.

Now, change `TracedResource.hello()` to use `KafkaService.send2()` instead of `send()`:

    @GET
    @Path("/hello")
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
    //    kafkaService.send();
    kafkaService.send2();
    return "hello";
    }

As you can see in the code, `KafkaService.send2()` builds a `CloudEvent`, which is sent to the same topic as in `send()`.

Rebuild the application, run it and try running `TracedResourceTest.testHelloEndpoint()` again.

As you can see from the System's output, the received message contains a different tracing id than the one in the sent message. The original tracing id is lost.

Therfore, in Jaeger UI (http://localhost:16686/) spans aren't nested.